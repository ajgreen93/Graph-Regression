\documentclass{article}
\usepackage{amsmath}
\usepackage{amsfonts, amsthm, amssymb}
\usepackage{graphicx}
\usepackage[colorlinks]{hyperref}
\usepackage[parfill]{parskip}
\usepackage{algpseudocode}
\usepackage{algorithm}
\usepackage{enumerate}
\usepackage[shortlabels]{enumitem}
\usepackage{fullpage}
\usepackage{mathtools}

\usepackage{natbib}
\renewcommand{\bibname}{REFERENCES}
\renewcommand{\bibsection}{\subsubsection*{\bibname}}

\DeclarePairedDelimiterX{\norm}[1]{\lVert}{\rVert}{#1}

\newcommand{\eqdist}{\ensuremath{\stackrel{d}{=}}}
\newcommand{\Graph}{\mathcal{G}}
\newcommand{\Reals}{\mathbb{R}}
\newcommand{\Identity}{\mathbb{I}}
\newcommand{\Xsetistiid}{\overset{\text{i.i.d}}{\sim}}
\newcommand{\convprob}{\overset{p}{\to}}
\newcommand{\convdist}{\overset{w}{\to}}
\newcommand{\Expect}[1]{\mathbb{E}\left[ #1 \right]}
\newcommand{\Risk}[2][P]{\mathcal{R}_{#1}\left[ #2 \right]}
\newcommand{\Prob}[1]{\mathbb{P}\left( #1 \right)}
\newcommand{\iset}{\mathbf{i}}
\newcommand{\jset}{\mathbf{j}}
\newcommand{\myexp}[1]{\exp \{ #1 \}}
\newcommand{\abs}[1]{\left \lvert #1 \right \rvert}
\newcommand{\restr}[2]{\ensuremath{\left.#1\right|_{#2}}}
\newcommand{\ext}[1]{\widetilde{#1}}
\newcommand{\set}[1]{\left\{#1\right\}}
\newcommand{\seq}[1]{\set{#1}_{n \in \N}}
\newcommand{\Xsetotp}[2]{\langle #1, #2 \rangle}
\newcommand{\floor}[1]{\left\lfloor #1 \right\rfloor}
\newcommand{\Var}{\mathrm{Var}}
\newcommand{\Cov}{\mathrm{Cov}}
\newcommand{\Xsetiam}{\mathrm{diam}}

\newcommand{\emC}{C_n}
\newcommand{\emCpr}{C'_n}
\newcommand{\emCthick}{C^{\sigma}_n}
\newcommand{\emCprthick}{C'^{\sigma}_n}
\newcommand{\emS}{S^{\sigma}_n}
\newcommand{\estC}{\widehat{C}_n}
\newcommand{\hC}{\hat{C^{\sigma}_n}}
\newcommand{\vol}{\text{vol}}
\newcommand{\spansp}{\mathrm{span}~}
\newcommand{\1}{\mathbf{1}}

\newcommand{\Linv}{L^{\Xsetagger}}
\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}

\newcommand{\emF}{\mathbb{F}_n}
\newcommand{\emG}{\mathbb{G}_n}
\newcommand{\emP}{\mathbb{P}_n}
\newcommand{\F}{\mathcal{F}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\R}{\mathcal{R}}
\newcommand{\Rd}{\Reals^d}

%%% Vectors
\newcommand{\thetast}{\theta^{\star}}
\newcommand{\betap}{\beta^{(p)}}
\newcommand{\betaq}{\beta^{(q)}}
\newcommand{\vardeltapq}{\varDelta^{(p,q)}}


%%% Matrices
\newcommand{\X}{X} % no bold
\newcommand{\Y}{Y} % no bold
\newcommand{\Z}{Z} % no bold
\newcommand{\Lgrid}{L_{\grid}}
\newcommand{\Xsetgrid}{D_{\grid}}
\newcommand{\Linvgrid}{L_{\grid}^{\Xsetagger}}

%%% Sets and classes
\newcommand{\Xset}{\mathcal{X}}
\newcommand{\Sset}{\mathcal{S}}
\newcommand{\Hclass}{\mathcal{H}}
\newcommand{\Pclass}{\mathcal{P}}
\newcommand{\Leb}{\mathcal{L}}

%%% Distributions and related quantities
\newcommand{\Pbb}{\mathbb{P}}
\newcommand{\Ebb}{\mathbb{E}}
\newcommand{\Qbb}{\mathbb{Q}}

%%% Operators
\newcommand{\Tadj}{T^{\star}}
\newcommand{\Xsetive}{\mathrm{div}}
\newcommand{\Xsetif}{\mathop{}\!\mathrm{d}}
\newcommand{\gradient}{\mathcal{D}}
\newcommand{\Hessian}{\mathcal{D}^2}
\newcommand{\dotp}[2]{\langle #1, #2 \rangle}

%%% Misc
\newcommand{\grid}{\mathrm{grid}}
\newcommand{\critr}{R_n}
\newcommand{\Xsetx}{\,dx}
\newcommand{\Xsety}{\,dy}
\newcommand{\Xsetr}{\,dr}
\newcommand{\Xsetxpr}{\,dx'}
\newcommand{\Xsetypr}{\,dy'}
\newcommand{\wt}[1]{\widetilde{#1}}
\newcommand{\ol}[1]{\overline{#1}}
\newcommand{\spec}{\mathrm{spec}}
\newcommand{\Unq}{\mathrm{Unq}}

%%% Order of magnitude
\newcommand{\soom}{\sim}

% \newcommand{\span}{\textrm{span}}

\newtheoremstyle{alden}
{6pt} % Space above
{6pt} % Space below
{} % Body font
{} % Indent amount
{\bfseries} % Theorem head font
{.} % Punctuation after theorem head
{.5em} % Space after theorem head
{} % Theorem head spec (can be left empty, meaning `normal')

\theoremstyle{alden} 


\newtheoremstyle{aldenthm}
{6pt} % Space above
{6pt} % Space below
{\itshape} % Body font
{} % Indent amount
{\bfseries} % Theorem head font
{.} % Punctuation after theorem head
{.5em} % Space after theorem head
{} % Theorem head spec (can be left empty, meaning `normal')

\theoremstyle{aldenthm}
\newtheorem{theorem}{Theorem}
\newtheorem{conjecture}{Conjecture}
\newtheorem{lemma}{Lemma}
\newtheorem{example}{Example}
\newtheorem{corollary}{Corollary}
\newtheorem{proposition}{Proposition}
\newtheorem{assumption}{Assumption}
\newtheorem{remark}{Remark}


\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]

\theoremstyle{remark}

\begin{document}
\title{Notes for Week 12/7/19 - 12/29/19}
\author{Alden Green}
\date{\today}
\maketitle

We observe random design and responses $(x_i,y_i)$ according to the following regression model: $x_1,\ldots,x_n$ are drawn i.i.d from distribution $P$ with density $p$ supported on $\mathcal{X} \subset \Reals^d$, and
\begin{equation*}
y_i = f(x_i) + \varepsilon_i,~ \varepsilon_i \overset{i.i.d}{\sim} \mathcal{N}(0,1).
\end{equation*}
Suppose we form the undirected, weighted graph $G_{n,r} = (X,W)$ with edge weights $W = (W_{ij})$ formed according to the kernel function $K$ as follows:
\begin{equation*}
W_{ij} = K_r(x_i,x_j) := \frac{1}{r^d}K(\norm{x_i - x_j}^2)
\end{equation*}
Let $L_n$ be the graph Laplacian operator associated with $G_{n,r}$, defined by the action
\begin{equation*}
L_nf(x) := \frac{1}{nr^2} \sum_{i = 1}^{n}(f(x_i) - f(x))K_r(x_i,x).
\end{equation*}
The graph Laplacian $L_n$ induces a class of roughness functionals $R_s(f)$, defined by
\begin{equation*}
R_{s,n}(f) = R_s(f;G_{n,r}) = \frac{1}{n} f^T L_n^s f
\end{equation*} 
We refer to $R_{s,n}(f)$ as the order-$s$ roughness functional. As part of our graph testing work, we have shown that if $f \neq 0$, then for any design points $X$ and resulting neighborhood graph $G$ with Laplacian $L$ such that
\begin{equation}
\label{eqn:bias_variance}
\norm{f}_n^2 \geq 2b\sqrt{\frac{2\kappa}{n^2}} + \frac{R_{s}(f;G) }{\lambda_{\kappa}^s}
\end{equation}
the graph spectral test $\phi_{\spec}$ makes a Type II error with probability at most $3/b$. Suppose
\begin{equation}
\label{eqn:graph_functionals}
\norm{f}_n^2 \geq \frac{1}{2}\norm{f}_2^2, ~R_s(f;G_{n,r}) \leq ||f||_{W_{d}^{s}(\Xset)}^2 ~~\textrm{and}~~ \lambda_{\kappa} \leq \kappa^{2/d};
\end{equation}
then it can be verified that choosing $\kappa = n^{-2d/(4s + d)}$, the equation~\eqref{eqn:bias_variance} is satisfied whenever $\norm{f}_2^2 \geq n^{-4s/(4s + d)}$. It is therefore sufficient to show that~\eqref{eqn:graph_functionals} holds with high probability over the random design points $X$.

In this week's notes, we will focus our attention on upper bounding the roughness functional $R_{n,s}(f)$. Our main results should take the following form: when (a) $f \in C^{s}(L)$ for a fixed constant $L$ (or more ideally $f \in \mathcal{W}^{s}(L)$), (b) the neighborhood graph radius $r = r(n)$ is properly chosen as a function of $n$, and (c) $K$ is an appropriately chosen kernel, the roughness functional satisfies
\begin{equation}
\label{eqn:roughness_functional_bound}
\mathbb{E}\left[R_{s,n}(f)\right] = O\left(L^2\right)
\end{equation}

These notes detail our current progress in showing such a result for different values of $s$. We showed the following useful representation of $R_{s,n}(f)$ in the \emph{8.7.19} Notes. For $k = (k_1,\ldots,k_n) \in [n]^s$, recursively defined the graph difference operator $D_k$ by 
\begin{equation*}
D_{k_1}f(x) = (f(x_{k_1}) - f(x))K_r(x_{k_1},x),~~ D_kf(x) = \bigl(D_{k_1}(D_{(k_2,\ldots,k_n)}f\bigr)(x)
\end{equation*}
Then when $s$ is even, letting $q = s/2$ we have
\begin{equation}
\label{eqn:roughness_functional_representation_even}
R_{s,n}(f) = \frac{1}{n}\sum_{i = 1}^{n} \left(\frac{1}{(nr^2)^q}\sum_{k \in [n]^q} D_kf(x_i)\right)^2
\end{equation}
and when $s$ is odd, letting $q = (s - 1)/2$ we have
\begin{equation}
\label{eqn:roughness_functional_representation_odd}
R_{s,n}(f) =  \frac{1}{2n^2r^2}\sum_{i,j = 1}^{n}\left(\frac{1}{(nr^2)^q}\sum_{k \in [n]^q}\bigl(D_kf(x_i) - D_kf(x_j)\bigr)\right)^2K_r(x_i,x_j)
\end{equation}
We have already obtained the desired bound on the 1st-order roughness functional $R_{1,n}(f)$, for any $f \in W_d^{1}(L)$, all scalings $r = r(n)$, and the uniform kernel. We therefore begin these notes with the case $s = 2$. 

\section{Bounding the 2nd-Order Roughness Functional}
The (first and) second order roughness functionals are somewhat special. These roughness functionals do not involve taking compositions of the difference operator $D_k$, and as a result, we get the desired bounds in expectation even when $r(n)$ is small. 
\begin{lemma}
	\label{lem:2nd_order_roughness_functional}
	Fix $L > 0$, and form the neighborhood graph $G_{n,r}$ using kernel $K(z) = \1\{z^2 \leq r^2\}$. Suppose $f \in C^2(L)$ and $p \in C^1(L)$. Then for any $r(n) \geq n^{-1/(2+d)}$ and , we have
	\begin{equation*}
	\Ebb(R_{2,n}(f)) = O(L^2)
	\end{equation*}
\end{lemma}

\section{Bounding the 3rd-Order Roughness Functional}

For the order-$s$ roughness functionals when $s \geq 3$, the graph Laplacian is forced to approximate higher order derivatives by composing difference operators-- that is, taking differences of differences, etc. In for the roughness functional to continue scaling at the desired rate, we will need $r(n)$ to be larger, and we cannot use the uniform kernel $K$ any longer. In the particular case $s = 3$, we will require a kernel $K$ which is bounded and compactly supported on $B(0,1)$, and additionally satisfies
\begin{equation*}
\int z^j K(z) = 0~~\textrm{for $j = 1,2$.}
\end{equation*}
We then have the following result.
\begin{lemma}
	\label{lem:3rd_order_roughness_functional}
	Suppose $f \in C^{3}(L)$ for some $L > 0$, and further suppose $p \in C^{2}(L)$. For any kernel $K$ which satisfies the previous conditions, and any $r(n) \geq n^{-1/(4+d)}$, we have that
	\begin{equation*}
	\Ebb(R_{s,n}(f)) = O(1)
	\end{equation*} 
\end{lemma}

\section{\textcolor{red}{Bounding the Roughness Functional in Expectation}}

\textcolor{red}{WARNING:} The following Lemma is not proved, but it is the result I am trying to prove. After the Lemma is stated, I go into some detail about how I intend to prove it. 

For an integer $\ell > 0$, we will say $K$ is an order-$\ell$ kernel
\begin{equation*}
\int K(z) = 1 ~~\textrm{and}~~\int z^j K(z) = 0,~~\textrm{for $j = 1,\ldots,\ell$}
\end{equation*}
and further $K$ is $\ell$ times continuously differentiable with $K^{j}(z) = O(z^j K(z))$ for $j = 1,\ldots,s$.

\begin{lemma}
	\label{lem:roughness_functional_expectation}
	Suppose $f \in C^{s}(L)$ for some $s,L > 0$, and further suppose $p \in C^{\ell}(L)$ for $\ell = \floor{s}$ the largest integer strictly less than $s$. For any order-$\ell$ kernel $K$ and any $1 \geq r(n) \geq n^{-1/(2(s - 1)+d)}$, we have that
	\begin{equation*}
	\Ebb(R_{s,n}(f)) = O(1)
	\end{equation*} 
\end{lemma}
When $s \geq 3$ the graph Laplacian approximates higher-order derivatives by composing difference operators. The crudeness of this approximation means that in Lemma~\ref{lem:roughness_functional_expectation} we allow for a slower scaling of $r(n)$ than we did in Lemmas~\ref{lem:2nd_order_roughness_functional} and~\ref{lem:3rd_order_roughness_functional}. At a high level, however, we prove Lemma~\ref{lem:roughness_functional_expectation} in a similar fashion to Lemma~\ref{lem:2nd_order_roughness_functional}. We first break the sum into cases according to the number of unique indices, then bound the expectation case by case. 
The following Lemma will be the workhorse which supplies a sufficient bound in each case.
\begin{lemma}
	\label{lem:expected_difference_operators}
	Let $q = s/2$ when $s$ is even, and $q = (s - 1)/2$ when $s$ is odd. Under the same conditions as Lemma~\ref{lem:roughness_functional_expectation}, for any indices $k = (k_1,\ldots,k_q)$ and $\ell = (\ell_1,\ldots,\ell_q)$, we have
	\begin{equation}
	\label{eqn:expected_difference_operators_1}
	\Ebb(D_kf(x_i) D_\ell f(x_i)) =
	\begin{cases*}
	O(r^{2s}), & ~~\textrm{if all indices are distinct} \\
	O(r^{2} r^{d(\abs{k \cup \ell \cup i} - (2q + 1))}), & ~~\textrm{otherwise}~ 
	\end{cases*}
	\end{equation}
	Additionally, we have
	\begin{equation}
	\label{eqn:expected_difference_operators_2}
	\Ebb(d_iD_kf(x_j) d_iD_\ell f(x_j)) =
	\begin{cases*}
	O(r^{2s}), & ~~\textrm{if all indices are distinct} \\
	O(r^{2} r^{d(\abs{k \cup \ell \cup i \cup j} - (2q + 2))}), & ~~\textrm{otherwise}~ 
	\end{cases*}
	\end{equation}
\end{lemma}

\section{Proofs}

\subsection{Proof of Lemma~\ref{lem:roughness_functional_expectation}}
We will take $s$ to be even, as the proof when $s$ is odd follows essentially the same steps. Now when $s$ is even, we have the decomposition
\begin{equation*}
R_{s,n}(f) = \frac{1}{n^{s+1}r^{2s}} \sum_{i = 1}^{n} \sum_{k \in [n]^q} \sum_{\ell \in [n]^q} D_kf(x_i) D_{\ell}f(x_i)
\end{equation*}
For given index vectors $k,\ell$ and index $i$, let $I = \abs{k \cup \ell \cup i}$ be the total number of unique indices. We separate our analysis into cases based on the magnitude of $I$. 

When $I < s + 1$, there is at least one repeated index, and by Lemma~\ref{lem:expected_difference_operators} we have that
\begin{equation*}
\Ebb(D_kf(x_i)D_{\ell}f(x_i)) = O(r^2r^{d(I - (s + 1))}).
\end{equation*}
There are $O(n^{I})$ terms in $R_{s,n}(f)$ with exactly $I$ distinct indices. Therefore, the total contribution of such terms to the sum is $O(r^{-2(s - 1)}r^{d(I - (s + 1))}n^{I - (s + 1)}r)$. Since $r(n) \geq n^{-1/d}$, this increases with $I$. Taking $I = s$ to be as large as possible such that there is at least one repeated index, the contribution of these terms to the sum is $O(r^{-(2(s - 1) + d)}n^{-1}) = O(1)$, with the equality following by the restriction $r \geq n^{-1/(2(s - 1) + d)}$. 

When $I = s + 1$, every index in $\ell,k$ and $i$ is unique. Therefore by Lemma~\ref{lem:roughness_functional_expectation},  
\begin{equation*}
\Ebb(D_kf(x_i)D_{\ell}f(x_i)) = O(r^{2s}).
\end{equation*}
Since there are $O(n^{s+1})$ such terms, we have that the total contribution of these terms is $O(n^{s + 1}r^{2s}n^{-(s + 1)}r^{-2s}) = O(1)$.

\subsection{Proof of Lemma~\ref{lem:2nd_order_roughness_functional}}
We prove Lemma~\ref{lem:2nd_order_roughness_functional} in the case when $d = 1$.

\textcolor{red}{TODO:} Extend the proof to all values of $d$. It's not hard, just requires you to replace derivatives by partial derivatives.

Separating the squared sum in~\eqref{eqn:roughness_functional_representation_even} into diagonal and off-diagonal terms, we obtain
\begin{align*}
R_{2,n}(f) & = \frac{1}{n}\sum_{i = 1}^{n}\left(\frac{1}{nr^2}\sum_{j = 1}^{n} D_jf(x_i)\right)^2 \\
& = \frac{1}{n^3r^4}\sum_{i = 1}^{n} \sum_{j = 1}^{n}\underbrace{(D_jf(x_i))^2}_{V_1} + \frac{1}{n^3r^4}\sum_{i = 1}^{n} \sum_{j = 1} \sum_{k \neq j}\underbrace{(D_jf(x_i))(D_kf(x_i))}_{U_1}
\end{align*}

The expectation of $U_1$ will be of the right order of magnitude thanks to a cancellation of the first-order term in a Taylor expansion. Noting that the kernel $K$ satisfies
\begin{equation*}
\int z K(z) \,dz = 0
\end{equation*}
we therefore derive that for any $x \in \mathcal{X}$,
\begin{align*}
\mathbb{E}(D_jf(x)) & = \frac{1}{r}\int ((y - x)f'(x) + O(L(y-x)^2) K(y - x) p(y) \,dy \tag{by $f \in C^2(L)$} \\
& = \frac{1}{r}\int(y - x)K(y - x)f'(x)(p(x) + O(L(y - x))) \,dy + O(Lr^2)  \tag{by $p \in C^1(L)$}\\
& = \underbrace{\frac{f'(x) p(x)}{r} \int z K(z) \,dz}_{= 0} + O(Lr^2) = O(Lr^2).
\end{align*}
As a result, we have
\begin{equation*}
\frac{1}{n^3r^4}\sum_{i = 1}^{n} \sum_{j = 1} \sum_{k \neq j} \Ebb\left[(D_jf(x_i))(D_kf(x_i))\right] = \frac{1}{n^3r^4}\sum_{i = 1}^{n} \sum_{j = 1} \sum_{k \neq j} \Ebb\left[ \Ebb(D_kf(x)\mid x_i = x)^2\right] = O(L^2).
\end{equation*}

The expectation of the diagonal terms may be much larger, but on the other hand there are many fewer of them. Specifically, we compute
\begin{align*}
\Ebb\bigl((D_kf(x_i))^2\bigr) & = \Ebb\biggl(O\left(L^2(x_k - x_i)^2\right)\cdot K_r(x_k,x)^2\biggr) \\
& = O(L^2r^2)\cdot\Ebb(K_r(x_k,x_i)^2) = O(L^2 r)
\end{align*}
and therefore
\begin{equation*}
\frac{1}{n^3r^4}\sum_{i = 1}^{n} \sum_{j = 1}^{n} \Ebb\bigl((D_jf(x_i))^2\bigr) = \frac{1}{n} O(L^2 r^{-3}) = O(L^2)
\end{equation*}
where the second equality follows since by assumption when $d = 1$, $n^{-1} = O(r^{3})$. 

\section{Proof of Lemma~\ref{lem:3rd_order_roughness_functional}}
We prove Lemma~\ref{lem:3rd_order_roughness_functional} when $d = 1$ and $r(n) \geq n^{-1/5}$.

\textcolor{red}{TODO:} Prove for all dimensions $d$, by replacing derivatives with partial derivatives.

From~\eqref{eqn:roughness_functional_representation_odd}, we have
\begin{align*}
R_{3,n}(f) & = \frac{1}{2n^2r^2}\sum_{i,j = 1}^{n}\left(\frac{1}{(nr^2)}\sum_{k \in n}\bigl(D_kf(x_i) - D_kf(x_j)\bigr)\right)^2K_r(x_i,x_j) \\
& = \frac{1}{2n^4r^6}\sum_{i,j = 1}^{n} \sum_{k,\ell = 1}^{n} D_{i\ell}f(x_j) \cdot d_i(D_kf(x_j)).
\end{align*}
We separate our analysis into cases based on the distinct indices in the previous summation.

\paragraph{Case 1: $i = k = \ell$.}
In this case, we can rewrite the summand as
\begin{align*}
D_iif(x_j) d_iD_if(x_j) & = (d_if(x_j))^2 K_r(x_i,x_j)^3 \\
& \leq 4L^2r^2 \abs{K_r(x_i,x_j)^3}
\end{align*}
Therefore,
\begin{align*}
\Ebb(D_iif(x_j) d_iD_if(x_j)) & \leq 4L^2 r^2 \Ebb\bigl(\abs{K_r(x_i,x_j)^3}\bigr)\\
& \leq 4CL^3, \tag{Lemma~\ref{lem:expected_kernel}}
\end{align*}
and as a result
\begin{equation*}
\frac{1}{2n^4r^6}\sum_{i,j = 1}^{n} \Ebb(D_{ii}f(x_j) \cdot d_i(D_if(x_j))) \leq \frac{2CL^3}{n^2r^6} \leq \frac{2CL^3}{n^{4/5}}.
\end{equation*}

\paragraph{Case 2: $i = \ell \neq k$.}
In this case, we can rewrite the summand as $-(D_if(x_j))(d_iD_kf(x_j))K_r(x_i,x_j)$. We have that
\begin{equation*}
\abs{D_if(x_j)} \leq 2LrK(x_i,x_j),~~\textrm{and}~ \abs{d_iD_kf(x_j)} \leq 2Lr \bigl(\abs{K_r(x_k,x_i)} + \abs{K_r(x_{\ell},x_i)}\bigr)
\end{equation*}
Therefore, we can upper bound
\begin{equation*}
\abs{D_if(x_j)d_iD_kf(x_j)K_r(x_i,x_j)} \leq 4Lr^2K(x_i,x_j)^2\bigl(\abs{K_r(x_k,x_i)} + \abs{K_r(x_{\ell},x_i)}\bigr)
\end{equation*}
and the resultant expectation satisfies
\begin{equation*}
\Ebb\bigl(\abs{D_if(x_j)d_iD_kf(x_j)K_r(x_i,x_j)}\bigr) \leq 8CL^4r.
\end{equation*}
Since there are order $n^3$ terms in the sum for which $i = k \neq \ell$, we have
\begin{equation*}
\frac{1}{2n^4r^4}\sum_{\ell\neq k = i \neq j\neq }^{n} \Ebb(D_{ii}f(x_j) \cdot d_i(D_{\ell}f(x_j))) \leq \frac{8 C L^3}{r^5n} \leq 8 C L^3.
\end{equation*}
Note that by symmetry, the same analysis applies to the case $i = \ell \neq k$.
\paragraph{Case 3: $i \neq k = \ell$.}
In this case, we can rewrite the summand as $(d_{i}D_kf(x_j))^2K_r(x_i,x_j)$. We bound the order of magnitude of the composed difference operators using Taylor expansion:
\begin{align*}
\abs{d_{i}D_kf(x_j)} & = \abs{(f(x_k) - f(x_i))K_r(x_k,x_i) - (f(x_k) - f(x_j))K_r(x_k,x_j)} \\
& \leq \abs{(f(x_k) - f(x_i))}\abs{K_r(x_k,x_i)} + \abs{(f(x_k) - f(x_j))}\abs{K_r(x_k,x_ij)} \\
& \leq 2L\left(\abs{x_k - x_j} \abs{K_r(x_k,x_i)} + \abs{x_k - x_i} \abs{K_r(x_k,x_i)}\right) \\
& \leq 2Lr \bigl(\abs{K_r(x_k,x_i)} + \abs{K_r(x_{\ell},x_i)}\bigr)
\end{align*}
Taking expectation with respect to $x_k$, we have
\begin{align*}
\Ebb(\bigl(d_{i}D_kf(x_j)\bigr)^2|x_i,x_j) & \leq 8L^2r^2\left(\int K_r(x,x_i)^2 p(x)\,dx + \int K_r(x,x_j)^2 p(x)\,dx\right) \\
& \leq 16L^3r^{2} \int \left(\frac{1}{r}K(z/r)\right)^2 \,dz \tag{$p \in C^2(L)$} \\
& \leq 16L^3r \int \bigl(K(t)\bigr)^2 \,dt \tag{change of variables} \\
& \leq 16CL^3r. \tag{$K$ compactly supported and bounded}
\end{align*}
As a result, 
\begin{align*}
\Ebb((d_{i}D_kf(x_j))^2K_r(x_i,x_j)) & = \Ebb(\Ebb((d_{i}D_kf(x_j))^2|x_i,x_j)K_r(x_i,x_j)) \\
& \leq 16CL^3r\Ebb(\abs{K_r(x_i,x_j)}) \\
& \leq 16CL^3r.
\end{align*}
Since there are not quite $n^3$ terms in the sum with $i \neq k = \ell$, and since $r \geq n^{-1/5}$, 
\begin{equation*}
\frac{1}{2n^4r^6}\sum_{i \neq j \neq k = \ell \neq i}^{n} \Ebb(D_{ik}f(x_j) \cdot d_i(D_kf(x_j))) \leq \frac{8 C L^3}{r^5n} \leq 8 C L^3.
\end{equation*}

\paragraph{Case 4: $i,k,\ell$ all distinct.}
We rewrite the summand as $d_i(D_{\ell}f(x_j)) d_i(D_{k}f(x_j))K_r(x_i,x_j)$. Noting that
\begin{equation*}
d_i(D_{k}f(x_j)) = [f(x_k) - f(x_i)]K_r(x_k,x_i) -  [f(x_k) - f(x_j)]K_r(x_k,x_j)
\end{equation*}
by Lemma~\ref{lem:leading_term} we have that
\begin{equation*}
\abs{\Ebb(d_i(D_{k}f(x_j))|x_i,x_j)} \leq 2Lr^3.
\end{equation*}
Therefore,
\begin{align*}
\abs{\Ebb(d_i(D_{\ell}f(x_j)) d_i(D_{k}f(x_j))K_r(x_i,x_j))} & \leq \Ebb\biggl(\abs{\Ebb(d_k(D_{\ell}f(x_j))|x_i,x_j)\cdot\Ebb(d_k(D_{\ell}f(x_j))|x_i,x_j)\cdot K_r(x_k,x_j)}\biggr) \\
& \leq 4L^2r^6 \Ebb(\abs{K_r(x_k,x_j)}) \leq 4CL^2r^6.
\end{align*}
Since there are order $n^4$ terms in the summation for which $i,j,k$ and $\ell$ are all distinct, we have that
\begin{equation*}
\frac{1}{2n^4r^6} \sum_{i \neq j \neq k \neq \ell}^{n} \Ebb(D_{ik}f(x_j) d_iD_{\ell}f(x_j) K_r(x_i,x_j)) \leq 4C.
\end{equation*}
The above four cases cover all terms in the summation, and so we have proved Lemma~\ref{lem:3rd_order_roughness_functional}.
\section{Proof of Lemma~\ref{lem:expected_difference_operators}}

\subsection{Proof of~\eqref{eqn:expected_difference_operators_1}}

Let $k,\ell \in [n]^q$ be index vectors. We first prove the desired bound in the case when some indices are repeated, and then the desired bound in the case when all indices are distinct.

\paragraph{Repeated indices.}

Since $f \in C^1(L)$, for all index vectors $k,\ell \in [n]^q$ and indices $i \in [n]$, the product of iterated difference operators $D_kf(x_i) D_{\ell}f(x_i)$ satisfies
\begin{equation*}
\abs{D_kf(x_i) D_{\ell}f(x_i)} \leq 4^{q} L^2 r^{2 - 2q}
\end{equation*}
Moreover $D_kf(x_i) D_{\ell}f(x_i)$ will equal zero if there exists $x_j, j \in k \cup \ell \cup i$ such that
\begin{equation*}
\norm{x_j - x_h} > r,~~\textrm{for all $h \in k \cup \ell \cup i$}
\end{equation*}
Therefore $D_kf(x_i) D_{\ell}f(x_i)$ is nonzero with probability $O(r^{\abs{k \cup \ell \cup i} - 1})$, which along with the boundedness of $D_kf(x_i) D_{\ell}f(x_i)$ implies the claimed result.

\paragraph{All indices distinct.}

By the law of iterated expectation, we have
\begin{align}
\Ebb\left[D_kf(x_i)D_{\ell}f(x_i)\right] & = \Ebb\left[\Ebb\left(D_kf(x)|x_i = x\right) \Ebb\left(D_{\ell}f(x)|x_i = x\right)\right] \nonumber \\
& = \Ebb\left[\Ebb\left(D_kf(x)|x_i = x\right)^2\right] \label{eqn:expected_difference_operators_pf1}
\end{align}
Again applying the law of iterated expectation, letting $g$ be the function given by $g(x) = \Ebb(D_1f(x))$, we have
\begin{align*}
\Ebb(D_kf(x)) & = \Ebb(\Ebb(D_{k}f(x)|x_{k_1},\ldots,x_{k_{q-1}})) \\
& = \Ebb((D_{k_1\cdots k_{q - 1}}g)(x)).
\end{align*}
By Lemma~\ref{lem:leading_term}, we have that $g(x) = O(r^s)$ for all values of $x$, and therefore
\begin{equation*}
(D_{k_1\cdots k_{q_1}}g)(x) = O(r^{s - d(q - 1)})
\end{equation*}
Since $(D_{k_1\cdots k_{q_1}}g)(x)$ is nonzero with probability $O(r^{d(q - 1)})$, we have that 
\begin{equation*}
\Ebb(D_kf(x)) = \Ebb((D_{k_1\cdots k_{q - 1}}g)(x)) = O(r^s),
\end{equation*}
and the desired result follows from~\eqref{eqn:expected_difference_operators_pf1}.

\subsection{Proof of~\eqref{eqn:expected_difference_operators_2}}

The proof of~\eqref{eqn:expected_difference_operators_2} is essentially the same, and we do not reproduce it here.
\section{Auxiliary Results.}
\begin{lemma}
	\label{lem:difference_operator_taylor}
	When $f \in C^s(L)$, for any $k \in [n]$ 
	\begin{equation*}
	D_kf(x) = \left(\sum_{r = 1}^{s - 1} (x_k - x)^r f^{(r)}(x) + O((x_k - x)^{s})\right) \cdot K_r(x_k,x)
	\end{equation*}
\end{lemma}

\begin{lemma}
	\label{lem:expected_kernel}
	When $K$ is a bounded and compactly supported kernel, then for any $s$ and for all $x \in \Rd$
	\begin{equation*}
	\Ebb(\abs{K(x_i,x)}^s) \leq CLr^{(1 - s)d}
	\end{equation*}
\end{lemma}

\begin{lemma}
	\label{lem:leading_term}
	When $f \in C^s(L)$ and $p \in C^{s - 1}(L)$, we have that 
	\begin{equation*}
	\Ebb(\left(f(x_{\ell}) - f(x)\right)K_r(x_{\ell},x)) \leq Lr^s.
	\end{equation*}
\end{lemma}


\end{document}